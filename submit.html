<?xml version="1.0" encoding="UTF-8"?>
<div xmlns="http://www.w3.org/1999/xhtml" data-template="templates:surround" data-template-with="templates/page.html" data-template-at="content">
    <div class="page-header">
        <h1>Pushing data into the database</h1>
    </div>
    <div class="panel panel-default">
        <h2 class="panel-heading">From OIFits files...</h2>
        <form action="modules/upload-urls.xql" method="post" name="oifits" class="panel-body">
            <p>
                Add public, remotely available OIFits files. The files are retrieved from the specified URLs and analyzed to extract the relevant metadata for the database.
                At the moment the submitted material is considered public.
            </p>
            <fieldset>
                <label for="obs_collection">Collection name</label>
                <div class="controls">
                    <input name="obs_collection" type="text"/>
                </div>
            </fieldset>
            <fieldset>
                <label for="calib_level">Calibration level (0,1,2,3)</label>
                <div class="controls">
                    <input name="calib_level" type="number" min="0" max="3" step="1"/>
                </div>
            </fieldset>
            <fieldset>
                <label for="bib_reference">Bibcode</label>
                <div class="controls">
                    <input name="bib_reference" type="text"/>
                </div>
            </fieldset>
            <fieldset>
                <label for="keywords">Keywords</label>
                <div class="controls">
                    <input name="keywords" type="text"/>
                </div>
            </fieldset>
            <!-- add data_rights and obs_release_data -->
            <fieldset>
                <label for="obs_creator_name">Creator name</label>
                <div class="controls">
                    <input name="obs_creator_name" type="text" data-template="app:input-user-name"/>
                </div>
            </fieldset>
            <fieldset>
                <label for="urls">File URLs</label>
                <div class="controls">
                    <textarea name="urls" placeholder="One URL per file to analyze, whitespace separated" rows="8" class="col-md-12"/>
                </div>
            </fieldset>
            <div class="form-group">
                <button class="btn btn-primary btn-lg" name="submit" type="submit" id="oifits">Add</button>
            </div>
        </form>
    </div>
    <div class="panel panel-default">
        <h2 class="panel-heading">From a collection of OIFits files on <a href="http://vizier.u-strasbg.fr/viz-bin/VizieR">VizieR</a>...</h2>
        <form action="modules/upload-vizier.xql" method="post" name="vizier" class="panel-body">
            <p>
                The <a href="http://vizier.u-strasbg.fr/viz-bin/VizieR">VizieR</a> database contains catalogs of observations associated with paper.
                Given the id of such a catalog, the service can retrieve the files and other data from the associated catalog description.
                See also ticket <a href="http://trac.jmmc.fr/jmmc-sw/ticket/549">#549 - Permit upload of OIFits L3 collection attached to article</a>.
            </p>
            <p>
                For example catalog named <a href="http://cdsarc.u-strasbg.fr/viz-bin/Cat?cat=J%2FA%2BA%2F545%2FA130">J/A+A/545/A130</a>.
            </p>
            <!-- <div class="alert-error/alert-success/alert-info"></div> -->
            <fieldset>
                <label for="cat">Catalog</label>
                <div class="controls">
                    <input name="cat" placeholder="Paste the catalog name"/>
                </div>
            </fieldset>
            <div class="form-group">
                <button class="btn btn-primary btn-lg" name="submit" type="submit" id="vizier">Add</button>
            </div>
        </form>
    </div>
    <div class="panel panel-default">
        <h2 class="panel-heading">From metadata file...</h2>
        <form action="modules/upload-meta.xql" method="post" name="metadata" class="panel-body">
            <p>
                The user can also choose to process his observations locally and upload only their metadata by submitting a file of metadata in XML format.
            </p>
            <p>
                A <a href="http://www.jmmc.fr/twiki/bin/view/Jmmc/Software/OiDbPionier">wiki page</a> is documenting the file format.
                See also ticket <a href="http://trac.jmmc.fr/jmmc-sw/ticket/550">#550 - Upload of preprocessed metadata (L0, L2, L3)</a>.
            </p>
            <fieldset>
                <label for="file">Metadata file</label>
                <input name="file" type="file" placeholder="Drop file here or select a file to upload"/>
            </fieldset>
            <div class="form-group">
                <button class="btn btn-primary btn-lg" name="submit" type="submit" id="metadata">Upload</button>
            </div>
        </form>
    </div>
    <div class="panel panel-default">
        <h2 class="panel-heading">From an external database/service...</h2>
        <div class="panel-body">
            <p>
                The service can retrieve data from other databases and services.
                At the moment only the retrieval of VEGA observation from the <a href="http://vegaobs-ws.oca.eu/">VegaObs database and Web Service</a> is implemented.
                This operation is manual and performed by an administrator of the application.
            </p>
            <p>
                See ticket <a href="http://trac.jmmc.fr/jmmc-sw/ticket/557">#557 - Provide system to upload from external databases</a> and this <a href="http://www.jmmc.fr/twiki/bin/view/Jmmc/Software/OiDbVega">wiki page</a>.
            </p>
        </div>
    </div>
    
    <!-- a Bootstrap modal dialog for reporting success/failure in submits -->
    <div class="modal fade" id="report" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                    <h4 class="modal-title">Submit report</h4>
                </div>
                <div class="modal-body"/>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        $(function () {
            $('form').submit(function (e) {
                var $form = $(this);
                var $report = $('#report');
                var $report_body = $('.modal-body', $report);

                // prevent other clicks on buttons during submit
                $("button[type='submit']").attr('disabled', 'disabled');
                // show something while waiting
                var $button = $("button[type='submit']", $form)
                $button.append('&lt;img src="resources/images/spinner.gif"/&gt;')

                var action = $form.attr('action');
                var params = $form.serialize();
                // do the submit with AJAX
                $.post(action, params).then(function(data) {
                    // build the list of success and add it to the report dialog
                    var $successes = $('response success', data);
                    if ($successes.length &gt; 0) {
                        var $ul = $('&lt;ul class="alert alert-success"/&gt;').appendTo($report_body);
                        $successes.each(function (i, s) {
                            var url = $(s).attr('url');
                            var msg = (typeof url != 'undefined' ? url + ': ' : '') + $(s).contents().first().text();
                            $('&lt;li/&gt;', { html: msg }).appendTo($ul)
                        });
                    }

                    // build the list of failures and add it to the report dialog
                    var $failures = $('response error', data);
                    if ($failures.length &gt; 0) {
                        var $ul = $('&lt;ul class="alert alert-danger"/&gt;').appendTo($report_body);
                        $failures.each(function (i, f) {
                            var url = $(f).attr('url');
                            var msg = (typeof url != 'undefined' ? url + ': ' : '') + $(f).contents().first().text();
                            $('&lt;li/&gt;', { html: msg }).appendTo($ul)
                        });
                    }

                    $report.modal('show');

                    $report.on('hide.bs.modal', function (e) {
                        // restore function on submit buttons
                        $("button[type='submit']").removeAttr('disabled');
                        $('img', $button).remove();
                        // remove reports, start fresh next time
                        $report_body.empty();
                    });
                });

                e.preventDefault();
            });
        });
    </script>
</div>
